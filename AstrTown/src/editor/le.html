<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstrTown 地图编辑器</title>
  <link rel="stylesheet" href="le-layout.css" />
</head>
<body id="app-root">
  <!-- 顶部工具栏 -->
  <div id="app-toolbar">
    <div class="toolbar-group toolbar-file">
      <button id="btn-save" type="button" title="保存 (S)">💾</button>
      <button id="btn-load-level" type="button" title="加载地图" onclick="document.getElementById('levelfile').click()">📂</button>
    </div>

    <div class="toolbar-sep"></div>

    <div class="toolbar-group toolbar-edit">
      <button id="btn-undo" type="button" title="撤销 (Ctrl+Z)">↩</button>
    </div>

    <div class="toolbar-sep"></div>

    <div class="toolbar-group toolbar-mode">
      <button class="mode-btn active" id="mode-terrain" data-mode="terrain" type="button" title="地形绘制">地形</button>
      <button class="mode-btn" id="mode-object" data-mode="object" type="button" title="放置对象">物体</button>
      <button class="mode-btn" id="mode-zone" data-mode="zone" type="button" title="绘制区域">区域</button>
    </div>

    <div class="toolbar-sep"></div>

    <div class="toolbar-group toolbar-view">
      <form name="myForm" id="grid-size-form">
        <label><input type="radio" name="radioTiledim" value="16" /> 16px</label>
        <label><input type="radio" name="radioTiledim" value="32" checked /> 32px</label>
      </form>
      <button id="btn-fill" type="button" title="填充背景层" onclick="fill0()">填充</button>
    </div>
  </div>

  <!-- 主工作区 -->
  <div id="app-workspace">
    <!-- 左侧导航 -->
    <nav id="app-sidebar" aria-label="编辑器功能导航">
      <button class="sidebar-btn active" data-panel="terrain" type="button" title="地形绘制">🗺</button>
      <button class="sidebar-btn" data-panel="layers" type="button" title="图层管理">📋</button>
      <button class="sidebar-btn" data-panel="sem-objects" type="button" title="语义物体">📌</button>
      <button class="sidebar-btn" data-panel="sem-zones" type="button" title="语义区域">🔲</button>
      <button class="sidebar-btn" data-panel="files" type="button" title="资源文件">📁</button>
    </nav>

    <!-- 中央画布区 -->
    <div id="app-canvas-area">
      <div id="canvas-wrapper">
        <div id="compositepane">
          <canvas id="composite" width="2048" height="1536"></canvas>
        </div>

        <!-- 后台隐藏画布：保留旧 DOM id 兼容已有初始化逻辑 -->
        <div id="layer0pane" class="legacy-hidden-pane">
          <canvas id="level0" class="bg-canvas" width="2048" height="1536"></canvas>
        </div>
        <div id="layer1pane" class="legacy-hidden-pane">
          <canvas id="level1" class="bg-canvas" width="2048" height="1536"></canvas>
        </div>
        <div id="layer2pane" class="legacy-hidden-pane">
          <canvas id="level3" class="bg-canvas" width="2048" height="1536"></canvas>
        </div>
        <div id="layer3pane" class="legacy-hidden-pane">
          <canvas id="level4" class="bg-canvas" width="2048" height="1536"></canvas>
        </div>

        <!-- 兼容旧 map 视图初始化 -->
        <div id="map" class="legacy-hidden-pane tabcontent">
          <canvas id="mapcanvas" width="2048" height="1536"></canvas>
        </div>
      </div>
    </div>

    <!-- 右侧属性区 -->
    <aside id="app-inspector">
      <!-- 地形面板 -->
      <div class="inspector-panel" id="panel-terrain">
        <div class="panel-section">
          <h3 class="panel-title">激活图层</h3>
          <div id="active-layer-selector">
            <button class="layer-btn active" data-layer="0" type="button">背景层 0</button>
            <button class="layer-btn" data-layer="1" type="button">背景层 1</button>
            <button class="layer-btn" data-layer="2" type="button">物件层 0</button>
            <button class="layer-btn" data-layer="3" type="button">物件层 1</button>
          </div>
        </div>

        <div class="panel-section">
          <h3 class="panel-title">瓦片选择</h3>
          <div id="tileset-container">
            <div id="tilesetpane">
              <canvas id="tileset" width="5632" height="8672"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 图层管理面板 -->
      <div class="inspector-panel hidden" id="panel-layers">
        <div class="panel-section">
          <h3 class="panel-title">图层列表</h3>
          <div id="layer-list">
            <div class="layer-item" data-layer="0"><span>背景层 0</span><button type="button">显隐</button><button type="button">锁定</button></div>
            <div class="layer-item" data-layer="1"><span>背景层 1</span><button type="button">显隐</button><button type="button">锁定</button></div>
            <div class="layer-item" data-layer="2"><span>物件层 0</span><button type="button">显隐</button><button type="button">锁定</button></div>
            <div class="layer-item" data-layer="3"><span>物件层 1</span><button type="button">显隐</button><button type="button">锁定</button></div>
          </div>
        </div>
      </div>

      <!-- 语义面板头部：折叠后依然可见 -->
      <div class="inspector-panel hidden" id="semantic-panel-header">
        <div class="panel-section">
          <button id="semantic-toggle-panel" class="semantic-collapse-btn" type="button" aria-expanded="true" aria-controls="semantic-panel-body">
            <span class="semantic-collapse-icon" aria-hidden="true">▼</span>
            <span class="semantic-collapse-text">收起面板</span>
          </button>

          <div class="semantic-mode-wrap">
            <div class="semantic-mode-segment" role="group" aria-label="语义编辑模式切换">
              <button id="semantic-normal-toggle" class="semantic-mode-btn is-active" type="button" aria-pressed="true">普通模式</button>
              <button id="semantic-placement-toggle" class="semantic-mode-btn" type="button" aria-pressed="false">物体放置</button>
              <button id="semantic-zone-toggle" class="semantic-mode-btn" type="button" aria-pressed="false">区域绘制</button>
            </div>
            <span id="semantic-placement-status" class="semantic-mode-status" aria-live="polite">当前：普通绘制模式</span>
          </div>
        </div>
      </div>

      <!-- 语义面板容器：保留 semantic-panel-body 供现有逻辑使用 -->
      <div id="semantic-panel-body">
        <!-- 语义物体面板 -->
        <div class="inspector-panel hidden" id="panel-sem-objects">
          <div class="panel-section">
            <h3 class="panel-title">物体列表</h3>
            <ul id="semantic-object-list" class="semantic-list"></ul>
            <div class="btn-row">
              <button id="semantic-new-object" class="semantic-btn" type="button">新建物体</button>
              <button id="semantic-delete-object" class="semantic-btn btn-danger" type="button">删除选中</button>
            </div>
          </div>

          <div class="panel-section">
            <h3 class="panel-title">物体创建 / 编辑</h3>
            <form id="semantic-object-form" class="semantic-form-grid" autocomplete="off">
              <div class="semantic-field">
                <label for="semantic-key">Key</label>
                <input id="semantic-key" name="key" type="text" required />
              </div>
              <div class="semantic-field">
                <label for="semantic-name">名称</label>
                <input id="semantic-name" name="name" type="text" required />
              </div>
              <div class="semantic-field">
                <label for="semantic-category">分类</label>
                <input id="semantic-category" name="category" type="text" />
              </div>
              <div class="semantic-field">
                <label for="semantic-interaction-hint">交互提示</label>
                <input id="semantic-interaction-hint" name="interactionHint" type="text" />
              </div>
              <div class="semantic-field semantic-field--full">
                <label for="semantic-description">描述</label>
                <textarea id="semantic-description" name="description" rows="3" cols="50"></textarea>
              </div>
              <div class="semantic-field semantic-field--full">
                <label for="semantic-occupied-tiles">占地（每行 dx,dy）</label>
                <textarea id="semantic-occupied-tiles" name="occupiedTiles" rows="4" cols="30">0,0</textarea>
              </div>
              <div class="semantic-field semantic-field-checkbox">
                <label for="semantic-blocks-movement">
                  <input id="semantic-blocks-movement" name="blocksMovement" type="checkbox" checked />
                  阻挡移动
                </label>
              </div>
              <div class="btn-row">
                <button id="semantic-save-object" class="semantic-btn" type="submit">保存物体</button>
                <button id="semantic-reset-form" class="semantic-btn" type="button">重置表单</button>
              </div>
            </form>
          </div>
        </div>

        <!-- 语义区域面板 -->
        <div class="inspector-panel hidden" id="panel-sem-zones">
          <div class="panel-section">
            <h3 class="panel-title">区域列表</h3>
            <ul id="semantic-zone-list" class="semantic-list"></ul>
            <div class="btn-row">
              <button id="semantic-new-zone" class="semantic-btn" type="button">新建区域</button>
              <button id="semantic-delete-zone" class="semantic-btn btn-danger" type="button">删除选中区域</button>
            </div>
          </div>

          <div class="panel-section">
            <h3 class="panel-title">区域创建 / 编辑</h3>
            <form id="semantic-zone-form" class="semantic-form-grid" autocomplete="off">
              <div class="semantic-field">
                <label for="semantic-zone-name">名称</label>
                <input id="semantic-zone-name" name="zoneName" type="text" required />
              </div>
              <div class="semantic-field">
                <label for="semantic-zone-priority">优先级</label>
                <input id="semantic-zone-priority" name="zonePriority" type="number" value="0" />
              </div>
              <div class="semantic-field semantic-field--full">
                <label for="semantic-zone-description">描述</label>
                <textarea id="semantic-zone-description" name="zoneDescription" rows="3" cols="50"></textarea>
              </div>
              <div class="semantic-field semantic-field--full">
                <label for="semantic-zone-activities">推荐活动（每行一个）</label>
                <textarea id="semantic-zone-activities" name="zoneActivities" rows="4" cols="50"></textarea>
              </div>
              <div class="btn-row">
                <button id="semantic-save-zone" class="semantic-btn" type="submit">保存区域信息</button>
                <button id="semantic-reset-zone-form" class="semantic-btn" type="button">重置区域表单</button>
              </div>
            </form>
            <div id="semantic-zone-primary">该格子主区域：无</div>
          </div>
        </div>
      </div>

      <!-- 文件面板 -->
      <div class="inspector-panel hidden" id="panel-files">
        <div class="panel-section">
          <h3 class="panel-title">地图文件</h3>
          <button type="button" onclick="document.getElementById('levelfile').click()">加载地图</button>
          <input id="levelfile" type="file" multiple hidden accept=".js" />
        </div>

        <div class="panel-section">
          <h3 class="panel-title">Tileset</h3>
          <button type="button" onclick="document.getElementById('tilesetfile').click()">更换 Tileset</button>
          <input id="tilesetfile" type="file" multiple hidden accept=".png,.jpg" />
        </div>

        <div class="panel-section">
          <h3 class="panel-title">精灵动画</h3>
          <button type="button" onclick="document.getElementById('spritesheet').click()">加载 Spritesheet</button>
          <input id="spritesheet" type="file" multiple hidden accept=".png" />
        </div>

        <div class="panel-section">
          <h3 class="panel-title">底图参考</h3>
          <button type="button" onclick="document.getElementById('compositepng').click()">加载底图 PNG</button>
          <input id="compositepng" type="file" multiple hidden accept=".png" />
        </div>

        <div class="panel-section">
          <h3 class="panel-title">导出</h3>
          <button id="btn-save-composite" type="button" onclick="saveCompositeAsImage()">导出合成 PNG</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- 底部状态栏 -->
  <div id="app-statusbar">
    <span id="status-layer">图层：背景层0</span>
    <span id="status-coord">坐标：-</span>
    <span id="status-mode">模式：地形绘制</span>
    <span id="status-zone">主区域：-</span>
  </div>

  <script src="le.js" type="module"></script>
</body>
</html>
