# AstrTown 项目架构总清单

> **文档版本**: 1.0
> **创建日期**: 2026-02-22
> **文档用途**: 架构优化咨询材料

---

## 目录

1. [项目概述](#1-项目概述)
2. [模块清单](#2-模块清单)
3. [模块详细分析](#3-模块详细分析)
4. [模块间关系图](#4-模块间关系图)
5. [架构特点](#5-架构特点)
6. [技术债务](#6-技术债务)
7. [附录](#7-附录)

---

## 1. 项目概述

### 1.1 项目简介

AstrTown 是一个基于 Convex 后端和 React + Pixi.js 前端的 2D 游戏世界，支持多 Agent 对话、NPC 外部控制、实时交互等功能。项目采用 WebSocket 网关架构，支持 Bot 和 AstrBot 插件接入。

### 1.2 技术栈

| 层级 | 技术栈 |
|-------|---------|
| **前端** | React 18, TypeScript, Vite, Pixi.js, @pixi/react, pixi-viewport, @pixi/sound |
| **后端** | Convex (数据库 + 函数 + 实时同步) |
| **网关** | Node.js, WebSocket, HTTP API |
| **插件** | Python, AstrBot 框架 |
| **样式** | Tailwind CSS, react-i18next |
| **工具** | Docker, docker-compose |

### 1.3 核心模块划分

项目分为以下 11 个主要模块：

1. **gateway** - WebSocket 网关服务
2. **convex/engine/util** - 游戏引擎抽象层和工具库
3. **convex/agent** - Agent 记忆系统（外部注入/检索）
4. **aiTown/基础** - 游戏世界基础类
5. **aiTown/agent** - Agent 状态机与行为调度
6. **convex/根目录** - Convex 后端入口/胶水层
7. **convex/botApi-npcService** - Bot API 和 NPC 服务
8. **src/components** - 前端 React UI 组件
9. **src/其他** - 前端应用入口、Hooks、国际化
10. **data** - 静态数据层
11. **plugin** - AstrBot 插件

### 1.4 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  React UI    │  │  Pixi 渲染   │  │  Hooks/工具   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      WebSocket 网关                         │
│                   (gateway 模块)                           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Convex 后端                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ aiTown 引擎   │  │ Agent 系统   │  │  API 服务    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     数据层 (data)                          │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                  AstrBot 插件 (plugin)                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 模块清单

### 2.1 模块统计汇总

| 序号 | 模块名称 | 文件数 | 总行数 | 总字符数 | 主要功能 |
|------|---------|--------|--------|----------|---------|
| 1 | gateway | 20 | 3,142 | 98,819 | WebSocket 网关服务（含社交关系命令本地处理、社交/记忆 HTTP 代理） |
| 2 | convex/engine/util | 21 | ~1,800 | 41,155 | 游戏引擎抽象层和工具库 |
| 3 | convex/agent | 3 | 399 | 12,232 | Agent 记忆系统（外部注入 + 最近记忆查询 + 向量检索） |
| 4 | aiTown/基础 | 10 | ~1,200 | 27,123 | 游戏世界基础类 |
| 5 | aiTown/agent | 7 | ~585 | 31,157 | Agent 状态机与行为调度 |
| 6 | convex/根目录 | 12 | 2,006 | 59,249 | Convex 后端入口/胶水层（含 social.ts 社交能力） |
| 7 | convex/botApi-npcService | 2 | 1,723 | 54,556 | Bot API 和 NPC 服务（扩展 social/memory 端点） |
| 8 | src/components | 26 | 2,760 | 94,600 | 前端 React UI 组件（含社交状态展示） |
| 9 | src/其他 | 10 | ~800 | 26,382 | 前端应用入口、Hooks、国际化 |
| 10 | data | 21 | ~1,500 | 26,382 | 静态数据层 |
| 11 | plugin | 10 | 2,593 | 95,467 | AstrBot 插件（反思回调 + social.* + 异步反思流水线） |
| **合计** | **11** | **~18,508** | **~567,122** | - |

### 2.2 模块文件详细清单

#### 2.2.1 gateway 模块 (20个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`gateway/src/index.ts`](gateway/src/index.ts) | ~100 | 3,200 | 网关入口 |
| [`gateway/src/wsHandler.ts`](gateway/src/wsHandler.ts) | ~500 | 16,929 | WebSocket 处理器 |
| [`gateway/src/commandRouter.ts`](gateway/src/commandRouter.ts) | ~484 | 19,197 | 命令路由器（含关系提议/回应本地处理） |
| [`gateway/src/eventDispatcher.ts`](gateway/src/eventDispatcher.ts) | ~180 | 6,351 | 事件分发器 |
| [`gateway/src/commandQueue.ts`](gateway/src/commandQueue.ts) | ~120 | 4,156 | 命令队列 |
| [`gateway/src/eventQueue.ts`](gateway/src/eventQueue.ts) | ~100 | 3,167 | 事件队列 |
| [`gateway/src/httpRoutes.ts`](gateway/src/httpRoutes.ts) | ~301 | 9,979 | HTTP 路由（含 social/memory 代理端点） |
| [`gateway/src/routes.ts`](gateway/src/routes.ts) | ~140 | 5,079 | 路由定义 |
| [`gateway/src/commandMapper.ts`](gateway/src/commandMapper.ts) | ~206 | 6,312 | 命令映射（扩展 propose/respond relationship） |
| [`gateway/src/astrtownClient.ts`](gateway/src/astrtownClient.ts) | ~274 | 7,670 | AstrTown 客户端（含关系写入接口） |
| [`gateway/src/auth.ts`](gateway/src/auth.ts) | ~120 | 3,896 | 认证模块 |
| [`gateway/src/connectionManager.ts`](gateway/src/connectionManager.ts) | ~54 | 1,486 | 连接管理（含 playerId 索引） |
| [`gateway/src/subscription.ts`](gateway/src/subscription.ts) | ~30 | 732 | 订阅管理 |
| [`gateway/src/config.ts`](gateway/src/config.ts) | ~60 | 1,991 | 配置管理 |
| [`gateway/src/metrics.ts`](gateway/src/metrics.ts) | ~80 | 2,933 | 指标收集 |
| [`gateway/src/queueRegistry.ts`](gateway/src/queueRegistry.ts) | ~63 | 2,205 | 队列注册表（含 social 事件优先级） |
| [`gateway/src/types.ts`](gateway/src/types.ts) | ~329 | 7,885 | 类型定义（扩展 social 事件与关系命令联合） |
| [`gateway/src/utils.ts`](gateway/src/utils.ts) | ~30 | 901 | 工具函数 |
| [`gateway/src/id.ts`](gateway/src/id.ts) | ~10 | 170 | ID 生成 |
| [`gateway/src/uuid.ts`](gateway/src/uuid.ts) | ~5 | 112 | UUID 生成 |

#### 2.2.2 convex/engine/util 模块 (21个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/engine/abstractGame.ts`](AstrTown/convex/engine/abstractGame.ts) | ~200 | 6,154 | 抽象游戏类 |
| [`AstrTown/convex/engine/historicalObject.ts`](AstrTown/convex/engine/historicalObject.ts) | ~400 | 11,726 | 历史对象系统 |
| [`AstrTown/convex/util/compression.ts`](AstrTown/convex/util/compression.ts) | ~60 | 1,745 | 压缩算法 |
| [`AstrTown/convex/util/FastIntegerCompression.ts`](AstrTown/convex/util/FastIntegerCompression.ts) | ~200 | 6,772 | 快速整数压缩 |
| [`AstrTown/convex/util/geometry.ts`](AstrTown/convex/util/geometry.ts) | ~150 | 4,203 | 几何计算 |
| [`AstrTown/convex/util/llm.ts`](AstrTown/convex/util/llm.ts) | ~800 | 25,514 | LLM 工具 |
| [`AstrTown/convex/util/minheap.ts`](AstrTown/convex/util/minheap.ts) | ~50 | 1,302 | 最小堆 |
| [`AstrTown/convex/util/asyncMap.ts`](AstrTown/convex/util/asyncMap.ts) | ~20 | 575 | 异步映射 |
| [`AstrTown/convex/util/object.ts`](AstrTown/convex/util/object.ts) | ~20 | 623 | 对象工具 |
| [`AstrTown/convex/util/isSimpleObject.ts`](AstrTown/convex/util/isSimpleObject.ts) | ~15 | 477 | 简单对象判断 |
| [`AstrTown/convex/util/assertNever.ts`](AstrTown/convex/util/assertNever.ts) | ~10 | 228 | 断言工具 |
| 测试文件 (10个) | ~300 | ~3,000 | 单元测试 |

#### 2.2.3 convex/agent 模块 (3个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/agent/embeddingsCache.ts`](AstrTown/convex/agent/embeddingsCache.ts) | ~110 | 3,561 | Embedding 缓存 |
| [`AstrTown/convex/agent/memory.ts`](AstrTown/convex/agent/memory.ts) | 235 | 7,121 | 记忆系统（外部注入、最近记忆查询、检索排序） |
| [`AstrTown/convex/agent/schema.ts`](AstrTown/convex/agent/schema.ts) | ~53 | 1,550 | Schema 定义 |

#### 2.2.4 aiTown/基础 模块 (10个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/aiTown/game.ts`](AstrTown/convex/aiTown/game.ts) | ~500 | 17,085 | 游戏核心类 |
| [`AstrTown/convex/aiTown/world.ts`](AstrTown/convex/aiTown/world.ts) | ~200 | 5,000 | 世界类 |
| [`AstrTown/convex/aiTown/player.ts`](AstrTown/convex/aiTown/player.ts) | ~150 | 4,000 | 玩家类 |
| [`AstrTown/convex/aiTown/location.ts`](AstrTown/convex/aiTown/location.ts) | ~100 | 2,500 | 位置类 |
| [`AstrTown/convex/aiTown/movement.ts`](AstrTown/convex/aiTown/movement.ts) | ~100 | 2,500 | 移动系统 |
| [`AstrTown/convex/aiTown/conversation.ts`](AstrTown/convex/aiTown/conversation.ts) | ~300 | 8,000 | 对话类 |
| [`AstrTown/convex/aiTown/ids.ts`](AstrTown/convex/aiTown/ids.ts) | ~50 | 1,175 | ID 类型定义 |
| [`AstrTown/convex/aiTown/inputs.ts`](AstrTown/convex/aiTown/inputs.ts) | ~50 | 1,000 | 输入定义 |
| [`AstrTown/convex/aiTown/inputHandler.ts`](AstrTown/convex/aiTown/inputHandler.ts) | ~20 | 342 | 输入处理器 |
| [`AstrTown/convex/aiTown/worldMap.ts`](AstrTown/convex/aiTown/worldMap.ts) | ~100 | 2,500 | 地图类 |

#### 2.2.5 aiTown/agent 模块 (7个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/aiTown/agent.ts`](AstrTown/convex/aiTown/agent.ts) | ~900 | 35,180 | Agent 核心类 |
| [`AstrTown/convex/aiTown/agentInputs.ts`](AstrTown/convex/aiTown/agentInputs.ts) | ~300 | 10,136 | Agent 输入 |
| [`AstrTown/convex/aiTown/agentOperations.ts`](AstrTown/convex/aiTown/agentOperations.ts) | ~150 | 5,465 | Agent 操作 |
| [`AstrTown/convex/aiTown/agentDescription.ts`](AstrTown/convex/aiTown/agentDescription.ts) | ~30 | 770 | Agent 描述 |
| [`AstrTown/convex/aiTown/conversationMembership.ts`](AstrTown/convex/aiTown/conversationMembership.ts) | ~50 | 1,126 | 对话成员 |
| [`AstrTown/convex/aiTown/worldEventDispatcher.ts`](AstrTown/convex/aiTown/worldEventDispatcher.ts) | ~100 | 3,000 | 事件分发 |
| [`AstrTown/convex/aiTown/insertInput.ts`](AstrTown/convex/aiTown/insertInput.ts) | ~50 | 1,500 | 输入插入 |

#### 2.2.6 convex/根目录 模块 (12个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/auth.ts`](AstrTown/convex/auth.ts) | ~425 | 12,923 | 用户认证 |
| [`AstrTown/convex/world.ts`](AstrTown/convex/world.ts) | ~257 | 8,333 | 世界管理 |
| [`AstrTown/convex/testing.ts`](AstrTown/convex/testing.ts) | ~232 | 7,532 | 测试工具 |
| [`AstrTown/convex/npcHistory.ts`](AstrTown/convex/npcHistory.ts) | ~230 | 7,126 | NPC 历史 |
| [`AstrTown/convex/music.ts`](AstrTown/convex/music.ts) | ~135 | 4,802 | 音乐生成 |
| [`AstrTown/convex/http.ts`](AstrTown/convex/http.ts) | 173 | 4,349 | HTTP 路由（含 social/memory 新端点） |
| [`AstrTown/convex/init.ts`](AstrTown/convex/init.ts) | ~113 | 3,438 | 初始化 |
| [`AstrTown/convex/messages.ts`](AstrTown/convex/messages.ts) | ~54 | 1,661 | 消息处理 |
| [`AstrTown/convex/crons.ts`](AstrTown/convex/crons.ts) | ~89 | 3,037 | 定时任务 |
| [`AstrTown/convex/schema.ts`](AstrTown/convex/schema.ts) | ~70 | 2,074 | Schema 定义 |
| [`AstrTown/convex/constants.ts`](AstrTown/convex/constants.ts) | ~86 | 3,301 | 常量定义 |
| [`AstrTown/convex/social.ts`](AstrTown/convex/social.ts) | 168 | 4,320 | 社交关系读写（affinity/relationship/state） |

#### 2.2.7 convex/botApi-npcService 模块 (2个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/convex/botApi.ts`](AstrTown/convex/botApi.ts) | 1,218 | 40,517 | Bot API 服务（新增 recent/social/memory inject 接口） |
| [`AstrTown/convex/npcService.ts`](AstrTown/convex/npcService.ts) | 505 | 15,763 | NPC 服务 |

#### 2.2.8 src/components 模块 (26个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/src/components/Game.tsx`](AstrTown/src/components/Game.tsx) | 85 | 3,399 | 游戏主容器 |
| [`AstrTown/src/components/PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx) | 131 | 4,603 | Pixi 渲染 |
| [`AstrTown/src/components/PixiViewport.tsx`](AstrTown/src/components/PixiViewport.tsx) | 56 | 1,833 | 视口容器 |
| [`AstrTown/src/components/PixiStaticMap.tsx`](AstrTown/src/components/PixiStaticMap.tsx) | 133 | 4,964 | 静态地图 |
| [`AstrTown/src/components/Player.tsx`](AstrTown/src/components/Player.tsx) | 91 | 3,038 | 玩家渲染 |
| [`AstrTown/src/components/Character.tsx`](AstrTown/src/components/Character.tsx) | 128 | 3,865 | 角色渲染 |
| [`AstrTown/src/components/PlayerDetails.tsx`](AstrTown/src/components/PlayerDetails.tsx) | 380 | 13,604 | 玩家详情（含社交状态查询、关系徽章、好感度可视化） |
| [`AstrTown/src/components/Messages.tsx`](AstrTown/src/components/Messages.tsx) | 171 | 6,550 | 消息列表 |
| [`AstrTown/src/components/MessageInput.tsx`](AstrTown/src/components/MessageInput.tsx) | 94 | 2,930 | 消息输入 |
| [`AstrTown/src/components/NpcHistoryDrawer.tsx`](AstrTown/src/components/NpcHistoryDrawer.tsx) | 116 | 3,860 | NPC 历史抽屉 |
| [`AstrTown/src/components/ConversationTree.tsx`](AstrTown/src/components/ConversationTree.tsx) | 45 | 1,247 | 对话树 |
| [`AstrTown/src/components/ConversationGroupItem.tsx`](AstrTown/src/components/ConversationGroupItem.tsx) | 109 | 4,133 | 对话分组 |
| [`AstrTown/src/components/ConversationSummaryItem.tsx`](AstrTown/src/components/ConversationSummaryItem.tsx) | 64 | 2,153 | 对话摘要 |
| [`AstrTown/src/components/ConversationDetailModal.tsx`](AstrTown/src/components/ConversationDetailModal.tsx) | 111 | 3,901 | 对话详情 |
| [`AstrTown/src/components/NpcManageModal.tsx`](AstrTown/src/components/NpcManageModal.tsx) | 313 | 11,439 | NPC 管理 |
| [`AstrTown/src/components/AuthModal.tsx`](AstrTown/src/components/AuthModal.tsx) | 154 | 5,135 | 认证模态框 |
| [`AstrTown/src/components/ConvexClientProvider.tsx`](AstrTown/src/components/ConvexClientProvider.tsx) | 27 | 895 | Convex 提供者 |
| [`AstrTown/src/components/DebugTimeManager.tsx`](AstrTown/src/components/DebugTimeManager.tsx) | 156 | 4,837 | 时间调试 |
| [`AstrTown/src/components/DebugPath.tsx`](AstrTown/src/components/DebugPath.tsx) | 36 | 1,186 | 路径调试 |
| [`AstrTown/src/components/PositionIndicator.tsx`](AstrTown/src/components/PositionIndicator.tsx) | 26 | 836 | 位置指示 |
| [`AstrTown/src/components/FreezeButton.tsx`](AstrTown/src/components/FreezeButton.tsx) | 39 | 1,114 | 冻结按钮 |
| [`AstrTown/src/components/PoweredByConvex.tsx`](AstrTown/src/components/PoweredByConvex.tsx) | 54 | 4,444 | Convex 标识 |
| [`AstrTown/src/components/modalStyles.ts`](AstrTown/src/components/modalStyles.ts) | 23 | 539 | 模态框样式 |
| [`AstrTown/src/components/buttons/Button.tsx`](AstrTown/src/components/buttons/Button.tsx) | 32 | ~800 | 按钮组件 |
| [`AstrTown/src/components/buttons/InteractButton.tsx`](AstrTown/src/components/buttons/InteractButton.tsx) | 67 | ~1,200 | 交互按钮 |
| [`AstrTown/src/components/buttons/MusicButton.tsx`](AstrTown/src/components/buttons/MusicButton.tsx) | 55 | 1,489 | 音乐按钮 |

#### 2.2.9 src/其他 模块 (10个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/src/App.tsx`](AstrTown/src/App.tsx) | 131 | 4,993 | 应用主组件 |
| [`AstrTown/src/main.tsx`](AstrTown/src/main.tsx) | 16 | 493 | 应用入口 |
| [`AstrTown/src/i18n.ts`](AstrTown/src/i18n.ts) | 18 | 356 | 国际化配置 |
| [`AstrTown/src/index.css`](AstrTown/src/index.css) | 185 | 4,588 | 全局样式 |
| [`AstrTown/src/toasts.ts`](AstrTown/src/toasts.ts) | 10 | 238 | Toast 工具 |
| [`AstrTown/src/vite-env.d.ts`](AstrTown/src/vite-env.d.ts) | 1 | 39 | 类型声明 |
| [`AstrTown/src/hooks/sendInput.ts`](AstrTown/src/hooks/sendInput.ts) | 51 | 1,695 | 输入发送 Hook |
| [`AstrTown/src/hooks/useAuth.tsx`](AstrTown/src/hooks/useAuth.tsx) | 290 | 7,424 | 认证 Hook |
| [`AstrTown/src/hooks/useHistoricalTime.ts`](AstrTown/src/hooks/useHistoricalTime.ts) | 143 | 4,926 | 历史时间 Hook |
| [`AstrTown/src/locales/zh-CN.ts`](AstrTown/src/locales/zh-CN.ts) | 140 | 3,311 | 中文翻译 |

#### 2.2.10 data 模块 (21个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`AstrTown/data/characters.ts`](AstrTown/data/characters.ts) | 121 | 4,729 | 角色数据 |
| [`AstrTown/data/gentle.js`](AstrTown/data/gentle.js) | 330 | 73,331 | 地图数据 |
| [`AstrTown/data/convertMap.js`](AstrTown/data/convertMap.js) | 74 | 2,795 | 地图转换脚本 |
| [`AstrTown/data/spritesheets/types.ts`](AstrTown/data/spritesheets/types.ts) | 26 | 421 | Spritesheet 类型 |
| [`AstrTown/data/spritesheets/f1.ts` ~ `f8.ts`](AstrTown/data/spritesheets/) | ~600 | ~16,500 | 角色 spritesheets |
| [`AstrTown/data/spritesheets/p1.ts` ~ `p3.ts`](AstrTown/data/spritesheets/) | ~180 | ~4,700 | 玩家 spritesheets |
| [`AstrTown/data/spritesheets/player.ts`](AstrTown/data/spritesheets/player.ts) | 59 | 1,574 | 玩家 spritesheet |
| [`AstrTown/data/animations/campfire.json`](AstrTown/data/animations/campfire.json) | 45 | 1,033 | 篝火动画 |
| [`AstrTown/data/animations/gentlesparkle.json`](AstrTown/data/animations/gentlesparkle.json) | ~30 | 827 | 闪烁动画 |
| [`AstrTown/data/animations/gentlesplash.json`](AstrTown/data/animations/gentlesplash.json) | ~50 | 1,479 | 水花动画 |
| [`AstrTown/data/animations/gentlewaterfall.json`](AstrTown/data/animations/gentlewaterfall.json) | ~50 | 1,473 | 瀑布动画 |
| [`AstrTown/data/animations/windmill.json`](AstrTown/data/animations/windmill.json) | ~80 | 2,485 | 风车动画 |

#### 2.2.11 plugin 模块 (10个文件)

| 文件路径 | 行数 | 字符数 | 功能描述 |
|---------|------|--------|---------|
| [`astrbot_plugin_astrtown/main.py`](astrbot_plugin_astrtown/main.py) | 513 | 20,488 | 插件主入口（反思回调注入/清理、关系工具、动态社交 context） |
| [`astrbot_plugin_astrtown/adapter/astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py) | 1,738 | 67,552 | 平台适配器（social.* 事件、会话追踪、异步反思流水线） |
| [`astrbot_plugin_astrtown/adapter/protocol.py`](astrbot_plugin_astrtown/adapter/protocol.py) | 120 | 2,541 | 协议定义 |
| [`astrbot_plugin_astrtown/adapter/astrtown_event.py`](astrbot_plugin_astrtown/adapter/astrtown_event.py) | 31 | 766 | 事件类 |
| [`astrbot_plugin_astrtown/SKILL.md`](astrbot_plugin_astrtown/SKILL.md) | 120 | 2,405 | NPC 行为指导 |
| [`astrbot_plugin_astrtown/_conf_schema.json`](astrbot_plugin_astrtown/_conf_schema.json) | 30 | 860 | 配置 schema |
| [`astrbot_plugin_astrtown/metadata.yaml`](astrbot_plugin_astrtown/metadata.yaml) | 6 | 279 | 插件元数据 |
| [`astrbot_plugin_astrtown/__init__.py`](astrbot_plugin_astrtown/__init__.py) | 10 | 228 | 包初始化 |
| [`astrbot_plugin_astrtown/adapter/__init__.py`](astrbot_plugin_astrtown/adapter/__init__.py) | 6 | 189 | 适配器包初始化 |
| [`astrbot_plugin_astrtown/adapter/id_util.py`](astrbot_plugin_astrtown/adapter/id_util.py) | 5 | 98 | ID 工具 |

---

## 3. 模块详细分析

### 3.1 gateway 模块

#### 3.1.1 模块概述

gateway 模块是 AstrTown 项目的 WebSocket 网关服务，负责：
- Bot/NPC 客户端的 WebSocket 连接管理（含 playerId 连接索引）
- 命令路由和事件分发（含关系命令本地处理与 social 事件扩展）
- 队列管理（命令队列、事件队列）
- 幂等性控制
- 连接认证和授权
- Convex botApi 的 HTTP 代理转发（social/memory 相关端点）

#### 3.1.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| WebSocket 连接管理 | [`wsHandler.ts`](gateway/src/wsHandler.ts) | 处理连接、认证、消息路由 |
| 命令路由 | [`commandRouter.ts`](gateway/src/commandRouter.ts) | 命令分发与本地处理（含 propose/respond relationship） |
| 事件分发 | [`eventDispatcher.ts`](gateway/src/eventDispatcher.ts) | 将事件推送到订阅的客户端 |
| 命令队列 | [`commandQueue.ts`](gateway/src/commandQueue.ts) | 管理待处理命令的优先级队列 |
| 事件队列 | [`eventQueue.ts`](gateway/src/eventQueue.ts) | 管理待分发事件的优先级队列 |
| HTTP 路由 | [`httpRoutes.ts`](gateway/src/httpRoutes.ts) | HTTP 代理端点（含 social/memory 新接口） |
| AstrTown 客户端 | [`astrtownClient.ts`](gateway/src/astrtownClient.ts) | 与 Convex 后端通信（含关系写入接口） |
| 认证 | [`auth.ts`](gateway/src/auth.ts) | Token 验证和会话管理 |
| 连接管理 | [`connectionManager.ts`](gateway/src/connectionManager.ts) | 连接生命周期管理（token/agentId/playerId 索引） |
| 指标收集 | [`metrics.ts`](gateway/src/metrics.ts) | 性能指标收集 |

#### 3.1.3 关键算法

**1. 命令路由算法（含社交关系本地处理）**
- 位置：[`commandRouter.ts`](gateway/src/commandRouter.ts)
- 功能：根据命令类型映射处理；对 `propose_relationship`、`respond_relationship` 在网关本地执行。
- 实现：
  - 通过 `commandMappings` 执行常规命令映射；
  - `propose_relationship`：按 `connections.getByPlayerId` 定位目标连接并入队 `social.relationship_proposed`；
  - `respond_relationship`：接受时调用 `/api/bot/social/relationship` 持久化并入队 `social.relationship_responded`。

**2. 事件分发与优先级算法**
- 位置：[`eventDispatcher.ts`](gateway/src/eventDispatcher.ts)、[`queueRegistry.ts`](gateway/src/queueRegistry.ts)
- 功能：将事件推送到订阅客户端，并按事件类型决定优先级。
- 实现：遍历订阅者推送；`social.relationship_proposed` 归类为高优先级。

**3. 幂等性控制**
- 位置：[`wsHandler.ts`](gateway/src/wsHandler.ts)
- 功能：通过 idempotency key 防止重复请求
- 实现：记录已处理的 idempotency key，重复请求返回缓存结果

#### 3.1.4 模块间关系

- **依赖**：
  - [`astrtownClient.ts`](gateway/src/astrtownClient.ts) → Convex 后端（含 social/relationship 写入）
  - [`httpRoutes.ts`](gateway/src/httpRoutes.ts) → Convex botApi HTTP 代理（social/affinity、social/state、memory/recent、memory/inject）
  - [`auth.ts`](gateway/src/auth.ts) → 用户认证系统
- **被依赖**：
  - Bot/NPC 客户端 → WebSocket 连接
  - AstrBot 插件 → WebSocket 连接

---

### 3.2 convex/engine/util 模块

#### 3.2.1 模块概述

该模块提供游戏引擎的抽象层和工具函数库，包括：
- 抽象游戏类定义
- 历史对象系统（时间序列数据）
- 压缩算法（quantize、deltaEncode、runLengthEncode、varint）
- 几何计算（距离、角度、寻路）
- LLM 工具（embedding、completion）
- 数据结构（最小堆、异步映射）

#### 3.2.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 抽象游戏类 | [`abstractGame.ts`](AstrTown/convex/engine/abstractGame.ts) | 定义游戏引擎接口 |
| 历史对象系统 | [`historicalObject.ts`](AstrTown/convex/engine/historicalObject.ts) | 时间序列数据压缩和查询 |
| 压缩算法 | [`compression.ts`](AstrTown/convex/util/compression.ts) | 数据压缩工具 |
| 快速整数压缩 | [`FastIntegerCompression.ts`](AstrTown/convex/util/FastIntegerCompression.ts) | 高性能整数压缩 |
| 几何计算 | [`geometry.ts`](AstrTown/convex/util/geometry.ts) | 距离、角度、寻路 |
| LLM 工具 | [`llm.ts`](AstrTown/convex/util/llm.ts) | Embedding 和 completion |
| 最小堆 | [`minheap.ts`](AstrTown/convex/util/minheap.ts) | 优先队列实现 |
| 异步映射 | [`asyncMap.ts`](AstrTown/convex/util/asyncMap.ts) | 异步缓存映射 |

#### 3.2.3 关键算法

**1. 历史对象压缩算法**
- 位置：[`historicalObject.ts`](AstrTown/convex/engine/historicalObject.ts)
- 功能：压缩时间序列数据
- 实现：
  - quantize：量化浮点数为整数
  - deltaEncode：存储差值而非绝对值
  - runLengthEncode：游程编码
  - varint：变长整数编码

**2. A* 寻路算法**
- 位置：[`geometry.ts`](AstrTown/convex/util/geometry.ts)
- 功能：在地图上找到最短路径
- 实现：使用最小堆的 A* 算法

**3. 向量检索算法**
- 位置：[`llm.ts`](AstrTown/convex/util/llm.ts)
- 功能：基于向量相似度检索记忆
- 实现：使用 OpenAI Embedding API 计算向量，余弦相似度排序

#### 3.2.4 模块间关系

- **依赖**：
  - Convex 数据库
  - OpenAI API（LLM）
- **被依赖**：
  - aiTown 引擎
  - Agent 系统
  - 移动系统

---

### 3.3 convex/agent 模块

#### 3.3.1 模块概述

该模块实现 Agent 记忆子系统（已重构为外部注入模式），包括：
- 外部记忆注入（conversation / relationship / reflection）
- 最近记忆查询
- 向量检索与排序
- Embedding 缓存

> 当前 `convex/agent` 不再承载 `conversation.ts` 对话生成链路，核心职责聚焦记忆存取与检索。

#### 3.3.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| Embedding 缓存 | [`embeddingsCache.ts`](AstrTown/convex/agent/embeddingsCache.ts) | 文本向量缓存与复用 |
| 记忆系统 | [`memory.ts`](AstrTown/convex/agent/memory.ts) | 外部注入、最近记忆查询、向量检索与排序 |
| Schema 定义 | [`schema.ts`](AstrTown/convex/agent/schema.ts) | memories / memoryEmbeddings / embeddingsCache 表结构 |

#### 3.3.3 关键算法

**1. 外部记忆注入数据构建**
- 位置：[`buildExternalMemoryData()`](AstrTown/convex/agent/memory.ts:23)
- 功能：根据 memoryType 构建标准化记忆数据结构
- 实现：
  - `relationship`：写入关系型 data
  - `reflection`：写入反思型 data
  - `conversation`（默认）：构造会话型 data

**2. 最近记忆查询算法**
- 位置：[`getRecentMemories`](AstrTown/convex/agent/memory.ts:99)
- 功能：按玩家读取最近 N 条记忆
- 实现：
  - 使用 `memories.playerId` 索引
  - 倒序读取并 `take(count)` 返回

**3. 向量检索 + 三因子排序与触达节流**
- 位置：[`searchMemories()`](AstrTown/convex/agent/memory.ts:129)、[`rankAndTouchMemories`](AstrTown/convex/agent/memory.ts:158)
- 功能：先按向量召回，再按综合得分重排并更新访问时间
- 实现：
  - 向量召回（overfetch）
  - relevance + importance + recency 三因子归一化排序
  - 按 `MEMORY_ACCESS_THROTTLE` 节流更新 `lastAccess`

#### 3.3.4 模块间关系

- **依赖**：
  - Convex 数据库
  - [`util/llm.ts`](AstrTown/convex/util/llm.ts)（embedding）
  - [`aiTown/ids.ts`](AstrTown/convex/aiTown/ids.ts)（ID 类型）
- **被依赖**：
  - [`botApi.ts`](AstrTown/convex/botApi.ts)（memory/search、memory/recent、memory/inject）
  - AstrBot 插件（经 gateway + botApi 间接调用）

---

### 3.4 aiTown/基础 模块

#### 3.4.1 模块概述

该模块提供游戏世界的基础类，包括：
- Game：游戏核心类
- World：世界管理
- Player：玩家对象
- Location：位置系统
- Movement：移动系统
- Conversation：对话系统
- WorldMap：地图系统

#### 3.4.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 游戏核心 | [`game.ts`](AstrTown/convex/aiTown/game.ts) | 游戏引擎核心逻辑 |
| 世界管理 | [`world.ts`](AstrTown/convex/aiTown/world.ts) | 世界状态管理 |
| 玩家对象 | [`player.ts`](AstrTown/convex/aiTown/player.ts) | 玩家状态和行为 |
| 位置系统 | [`location.ts`](AstrTown/convex/aiTown/location.ts) | 位置计算和判断 |
| 移动系统 | [`movement.ts`](AstrTown/convex/aiTown/movement.ts) | 移动路径和动画 |
| 对话系统 | [`conversation.ts`](AstrTown/convex/aiTown/conversation.ts) | 对话状态管理 |
| 地图系统 | [`worldMap.ts`](AstrTown/convex/aiTown/worldMap.ts) | 地图渲染和碰撞检测 |

#### 3.4.3 关键算法

**1. 移动算法**
- 位置：[`movement.ts`](AstrTown/convex/aiTown/movement.ts)
- 功能：计算玩家移动路径和动画
- 实现：
  - A* 寻路
  - 路径平滑
  - 动画状态机

**2. 对话状态机**
- 位置：[`conversation.ts`](AstrTown/convex/aiTown/conversation.ts)
- 功能：管理对话状态转换
- 实现：
  - 状态定义（invited、active、left）
  - 状态转换逻辑
  - 超时处理

#### 3.4.4 模块间关系

- **依赖**：
  - engine/abstractGame：引擎抽象
  - util/geometry：几何计算
  - data/characters：角色数据
- **被依赖**：
  - aiTown Agent
  - 前端渲染

---

### 3.5 aiTown/agent 模块

#### 3.5.1 模块概述

该模块实现 Agent 状态机与行为调度，包括：
- Agent：Agent 核心类
- AgentInputs：Agent 输入处理
- AgentOperations：Agent 操作（不再直接调用记忆生成）
- AgentDescription：Agent 描述
- ConversationMembership：对话成员
- WorldEventDispatcher：世界事件分发
- InsertInput：输入插入

#### 3.5.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| Agent 核心类 | [`agent.ts`](AstrTown/convex/aiTown/agent.ts) | Agent 状态和行为 |
| Agent 输入 | [`agentInputs.ts`](AstrTown/convex/aiTown/agentInputs.ts) | 输入定义和处理 |
| Agent 操作 | [`agentOperations.ts`](AstrTown/convex/aiTown/agentOperations.ts) | 异步操作收敛（agentRememberConversation → finishRememberConversation） |
| Agent 描述 | [`agentDescription.ts`](AstrTown/convex/aiTown/agentDescription.ts) | Agent 描述管理 |
| 对话成员 | [`conversationMembership.ts`](AstrTown/convex/aiTown/conversationMembership.ts) | 对话成员管理 |
| 事件分发 | [`worldEventDispatcher.ts`](AstrTown/convex/aiTown/worldEventDispatcher.ts) | 世界事件分发 |
| 输入插入 | [`insertInput.ts`](AstrTown/convex/aiTown/insertInput.ts) | 输入插入工具 |

#### 3.5.3 关键算法

**1. Agent 状态机**
- 位置：[`agent.ts`](AstrTown/convex/aiTown/agent.ts)
- 功能：管理 Agent 状态转换
- 实现：
  - 状态定义（idle、moving、thinking、speaking）
  - 状态转换逻辑
  - 行为调度

**2. 外部控制模式**
- 位置：[`agent.ts`](AstrTown/convex/aiTown/agent.ts)
- 功能：支持外部系统控制 Agent
- 实现：
  - 外部事件队列
  - 事件优先级
  - 事件处理

#### 3.5.4 模块间关系

- **依赖**：
  - aiTown 基础模块
  - 记忆链路由 botApi/memory 异步注入（aiTown/agent 不直接依赖 convex/agent）
  - engine/abstractGame：引擎抽象
- **被依赖**：
  - convex 根目录
  - botApi/npcService

---

### 3.6 convex/根目录 模块

#### 3.6.1 模块概述

该模块是 Convex 后端的入口/胶水层，包括：
- constants：全局常量
- crons：定时任务
- http：HTTP 路由入口（新增 social/memory 端点挂载）
- init：初始化入口
- messages：消息读写
- music：音乐生成
- npcHistory：NPC 历史查询
- schema：Schema 聚合
- testing：测试/运维工具
- world：世界生命周期
- auth：用户认证
- social：社交关系与好感度读写（新增文件）

#### 3.6.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 全局常量 | [`constants.ts`](AstrTown/convex/constants.ts) | 超时、节拍、对话参数 |
| 定时任务 | [`crons.ts`](AstrTown/convex/crons.ts) | 停止闲置世界、重启死掉的世界、清理旧数据 |
| HTTP 路由 | [`http.ts`](AstrTown/convex/http.ts) | 鉴权、bot API、NPC 服务、Replicate webhook、social/memory 扩展路由 |
| 初始化 | [`init.ts`](AstrTown/convex/init.ts) | 创建默认世界与引擎 |
| 消息读写 | [`messages.ts`](AstrTown/convex/messages.ts) | 查询/写入消息 |
| 音乐生成 | [`music.ts`](AstrTown/convex/music.ts) | Replicate 音乐生成与 webhook |
| NPC 历史 | [`npcHistory.ts`](AstrTown/convex/npcHistory.ts) | NPC 历史对话分组与详情 |
| Schema 聚合 | [`schema.ts`](AstrTown/convex/schema.ts) | 全局 schema 定义 |
| 测试工具 | [`testing.ts`](AstrTown/convex/testing.ts) | 清库、停机/恢复、调试数据 |
| 世界生命周期 | [`world.ts`](AstrTown/convex/world.ts) | 心跳、自动停机/重启、join/leave |
| 用户认证 | [`auth.ts`](AstrTown/convex/auth.ts) | 注册/登录/登出/查询 |
| 社交读写 | [`social.ts`](AstrTown/convex/social.ts) | updateAffinity/upsertRelationship/getSocialState/getPublicSocialState |

#### 3.6.3 关键算法

**1. Vacuum 分页清理**
- 位置：[`crons.ts`](AstrTown/convex/crons.ts)
- 功能：分页删除旧数据
- 实现：
  - 计算阈值
  - 分页删除
  - 递归调度

**2. 社交关系归一化写入**
- 位置：[`upsertRelationship`](AstrTown/convex/social.ts:52)
- 功能：确保任意玩家对关系写入到同一条记录
- 实现：
  - 通过 `sortPlayerIds` 固定 player1/player2 顺序
  - 以 `relationships.by_players` 索引 upsert

**3. 好感度区间更新**
- 位置：[`updateAffinity`](AstrTown/convex/social.ts:11)
- 功能：按增量更新好感并限制区间
- 实现：
  - `scoreDelta` 校验
  - 读取当前分值并 clamp 到 [-100, 100]

#### 3.6.4 模块间关系

- **依赖**：
  - aiTown/基础、agent、engine/util
  - data/characters、data/gentle
  - `affinities` / `relationships` 表（经 [`social.ts`](AstrTown/convex/social.ts)）
- **被依赖**：
  - 前端（通过 API）
  - gateway（通过 HTTP 代理）
  - [`botApi.ts`](AstrTown/convex/botApi.ts)（通过 `internal.social.*` 调用社交能力）

---

### 3.7 convex/botApi-npcService 模块

#### 3.7.1 模块概述

该模块包含两个核心文件：
- botApi.ts：外部 Bot API 服务（40,517 字符，1,218 行）
- npcService.ts：NPC 自助服务（15,763 字符，505 行）

其中 `botApi.ts` 已扩展社交与记忆能力，新增：
- `/api/bot/memory/recent`
- `/api/bot/social/affinity`
- `/api/bot/social/relationship`
- `/api/bot/social/state`
- `/api/bot/memory/inject`

#### 3.7.2 botApi.ts 核心功能

| 功能 | 说明 |
|------|------|
| Bot Token 认证 | 验证 Token 有效性和权限 |
| 命令映射 | 8 种命令类型到引擎输入的转换 |
| 幂等性控制 | 防止重复请求 |
| 事件队列 | 外部事件队列管理 |
| 批量命令 | 支持批量提交命令 |
| Agent 状态查询 | 获取 Agent 当前状态 |
| 世界状态查询 | 获取世界完整状态 |
| 记忆检索 | `/api/bot/memory/search` 向量检索记忆 |
| 最近记忆查询 | `/api/bot/memory/recent` 查询最近记忆 |
| 记忆注入 | `/api/bot/memory/inject` 注入外部记忆 |
| 社交好感写入 | `/api/bot/social/affinity` |
| 社交关系写入 | `/api/bot/social/relationship` |
| 社交状态查询 | `/api/bot/social/state` |

#### 3.7.3 npcService.ts 核心功能

| 功能 | 说明 |
|------|------|
| NPC 创建 | 创建 NPC 并生成 Token |
| NPC 列表 | 列出用户的 NPC |
| Token 管理 | 查看、重置 NPC Token |
| Session 认证 | 用户 Session 认证 |
| CORS 处理 | 跨域资源共享 |

#### 3.7.4 关键算法

**1. 命令映射与入队策略算法**
- 位置：[`botApi.ts`](AstrTown/convex/botApi.ts)
- 功能：将外部命令映射到引擎输入或外部事件队列
- 实现：
  - 命令映射表
  - 参数规范化
  - `enqueueMode` 分流（`immediate` / `queue`）

**2. 社交与记忆 HTTP 编排算法**
- 位置：[`botApi.ts`](AstrTown/convex/botApi.ts)
- 功能：统一鉴权后调用内部 social/memory 能力
- 实现：
  - social：调用 `internal.social.updateAffinity / upsertRelationship / getSocialState`
  - memory：调用 `internal.agent.memory.insertExternalMemory` 与 `agent.memory.getRecentMemories`

**3. NPC 创建等待算法**
- 位置：[`npcService.ts`](AstrTown/convex/npcService.ts)
- 功能：等待 NPC 创建完成
- 实现：
  - 轮询输入状态
  - 超时控制（30 秒）
  - 错误处理

#### 3.7.5 模块间关系

- **依赖**：
  - aiTown/agent、aiTown/基础
  - [`social.ts`](AstrTown/convex/social.ts)
  - [`agent/memory.ts`](AstrTown/convex/agent/memory.ts)
  - data/characters
- **被依赖**：
  - gateway（通过 HTTP）
  - AstrBot 插件（经 gateway 间接调用）

---

### 3.8 src/components 模块

#### 3.8.1 模块概述

该模块包含前端 React UI 组件，分为两大子系统：
- DOM/React UI 子系统：Game、PlayerDetails、Messages、Modal/Drawer 组件
- Pixi 渲染子系统：PixiGame、PixiViewport、PixiStaticMap、Player、Character

#### 3.8.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 游戏主容器 | [`Game.tsx`](AstrTown/src/components/Game.tsx) | 计算画布尺寸、拉取世界状态、渲染 Pixi 场景 |
| Pixi 渲染 | [`PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx) | 静态地图、玩家精灵、路径/点击目的地提示 |
| 视口容器 | [`PixiViewport.tsx`](AstrTown/src/components/PixiViewport.tsx) | 拖拽、缩放、惯性、边界 clamp |
| 静态地图 | [`PixiStaticMap.tsx`](AstrTown/src/components/PixiStaticMap.tsx) | 一次性 blit 为 Pixi Container，加载/播放动画 |
| 玩家渲染 | [`Player.tsx`](AstrTown/src/components/Player.tsx) | 从 ServerGame 读取角色、历史位置、状态 |
| 角色渲染 | [`Character.tsx`](AstrTown/src/components/Character.tsx) | Pixi 精灵渲染、spritesheet 加载与缓存 |
| 玩家详情 | [`PlayerDetails.tsx`](AstrTown/src/components/PlayerDetails.tsx) | 右侧面板、对话控制、聊天内容、社交状态可视化 |
| 消息列表 | [`Messages.tsx`](AstrTown/src/components/Messages.tsx) | 实时/归档消息、typing 指示、滚动到底部 |
| 消息输入 | [`MessageInput.tsx`](AstrTown/src/components/MessageInput.tsx) | contentEditable 段落、Enter 发送、typing 输入 |
| NPC 历史抽屉 | [`NpcHistoryDrawer.tsx`](AstrTown/src/components/NpcHistoryDrawer.tsx) | portal 到 body、按 npc+时区+参考时间查询 |
| NPC 管理 | [`NpcManageModal.tsx`](AstrTown/src/components/NpcManageModal.tsx) | 创建 NPC、查看 token、重置 token、复制 token |
| 认证模态框 | [`AuthModal.tsx`](AstrTown/src/components/AuthModal.tsx) | 登录/注册 Tab、表单校验 |
| 调试工具 | [`DebugTimeManager.tsx`](AstrTown/src/components/DebugTimeManager.tsx) | bufferHealth 曲线、intervals 与 engine status |
| 按钮组件 | [`buttons/Button.tsx`](AstrTown/src/components/buttons/Button.tsx) 等 | 统一按钮外观 |

#### 3.8.3 关键算法

**1. 地图点击移动：拖拽与点击的区分**
- 位置：[`PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx)
- 功能：区分拖拽和点击
- 实现：
  - pointerdown 记录 screenX/screenY
  - pointerup 计算像素位移
  - dist > 10 视为拖拽，跳过导航

**2. screen 坐标 → world/tile 坐标变换**
- 位置：[`PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx)
- 功能：转换屏幕坐标到游戏坐标
- 实现：
  - viewport.toWorld(e.screenX, e.screenY)
  - 除以 tileDim 得到 tile 坐标
  - Math.floor 得到目的地 tile

**3. 消息/成员事件的时间序合并**
- 位置：[`Messages.tsx`](AstrTown/src/components/Messages.tsx)
- 功能：合并消息和加入/离开事件
- 实现：
  - 将"消息节点"和"加入/离开节点"都映射为 {time, node}
  - 合并数组并按 time 排序
  - archived 对话的 left 事件强制排到最后

**4. spritesheet 解析缓存**
- 位置：[`Character.tsx`](AstrTown/src/components/Character.tsx)、[`PixiStaticMap.tsx`](AstrTown/src/components/PixiStaticMap.tsx)
- 功能：避免重复 parse 导致 TextureCache 冲突
- 实现：
  - 模块级缓存 Map<string, Promise<Spritesheet>>
  - key 为 textureUrl 或 url
  - 避免多个实例重复解析

#### 3.8.4 模块间关系

- **依赖**：
  - convex/根目录（API）
  - src/hooks（useAuth、useServerGame、useHistoricalTime、useSendInput）
  - data/characters（角色数据）
- **被依赖**：
  - src/App.tsx

---

### 3.9 src/其他 模块

#### 3.9.1 模块概述

该模块包含前端应用的核心配置、工具函数、自定义 Hooks 和国际化支持。

#### 3.9.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 应用主组件 | [`App.tsx`](AstrTown/src/App.tsx) | 整合认证、游戏界面和全局 UI |
| 应用入口 | [`main.tsx`](AstrTown/src/main.tsx) | React 应用入口，挂载根组件 |
| 国际化配置 | [`i18n.ts`](AstrTown/src/i18n.ts) | 配置和初始化 i18next |
| 全局样式 | [`index.css`](AstrTown/src/index.css) | 字体、动画、UI 组件样式 |
| Toast 工具 | [`toasts.ts`](AstrTown/src/toasts.ts) | Promise 错误处理的 Toast 通知 |
| 类型声明 | [`vite-env.d.ts`](AstrTown/src/vite-env.d.ts) | Vite 环境变量类型声明 |
| 输入发送 Hook | [`hooks/sendInput.ts`](AstrTown/src/hooks/sendInput.ts) | 向游戏引擎发送输入并等待结果 |
| 认证 Hook | [`hooks/useAuth.tsx`](AstrTown/src/hooks/useAuth.tsx) | 用户认证管理 |
| 历史时间 Hook | [`hooks/useHistoricalTime.ts`](AstrTown/src/hooks/useHistoricalTime.ts) | 历史时间管理 |
| 中文翻译 | [`locales/zh-CN.ts`](AstrTown/src/locales/zh-CN.ts) | 中文翻译配置 |

#### 3.9.3 关键算法

**1. 历史时间插值算法**
- 位置：[`useHistoricalTime.ts`](AstrTown/src/hooks/useHistoricalTime.ts)
- 功能：客户端与服务器时间的同步和插值
- 实现：
  - 动态速率调整（0.8/1.0/1.2）
  - 时间插值计算
  - 时间间隔匹配
  - 历史数据修剪

**2. 输入等待算法**
- 位置：[`sendInput.ts`](AstrTown/src/hooks/sendInput.ts)
- 功能：等待输入处理完成
- 实现：
  - 初始检查
  - 监听更新
  - 结果处理

**3. 认证 URL 推导算法**
- 位置：[`useAuth.tsx`](AstrTown/src/hooks/useAuth.tsx)
- 功能：从 Convex URL 推导 HTTP 基础 URL
- 实现：
  - 优先使用显式 Site URL
  - 从 Convex URL 推导（.convex.cloud → .convex.site）
  - 清理 URL

#### 3.9.4 模块间关系

- **依赖**：
  - convex/根目录（API）
  - convex/aiTown（类型）
- **被依赖**：
  - src/components

---

### 3.10 data 模块

#### 3.10.1 模块概述

该模块是游戏的静态数据层，提供三类核心数据：
- 角色数据：对话人格描述、精灵贴图、spritesheet 帧数据、移动速度常量
- 地图数据：背景层/物件层 tilemap、地图内动画精灵摆放信息
- 动画与精灵表数据：TexturePacker 风格 spritesheet JSON、TS 导出的 SpritesheetData

#### 3.10.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 角色数据 | [`characters.ts`](AstrTown/data/characters.ts) | Descriptions、characters、movementSpeed |
| 地图转换 | [`convertMap.js`](AstrTown/data/convertMap.js) | Tiled JSON → JS 模块转换 |
| 游戏地图 | [`gentle.js`](AstrTown/data/gentle.js) | tileset、bgtiles、objmap、animatedsprites |
| 动画数据 | [`animations/*.json`](AstrTown/data/animations/) | spritesheet JSON（frames/animations/meta） |
| 精灵表数据 | [`spritesheets/*.ts`](AstrTown/data/spritesheets/) | SpritesheetData（frames/animations/meta.scale） |
| Spritesheet 类型 | [`spritesheets/types.ts`](AstrTown/data/spritesheets/types.ts) | Frame 与 SpritesheetData 类型 |

#### 3.10.3 关键算法

**1. 地图 layer 数据转换（Tiled 1D → 引擎 2D/3D）**
- 位置：[`convertMap.js`](AstrTown/data/convertMap.js)
- 功能：转换 Tiled 导出的 JSON
- 实现：
  - 输入：Tiled layer 的 data（一维数组）与 width/height
  - 输出：[newArray]，其中 newArray[x][y]
  - 核心映射：newArray[i][j] = layerData[j * width + i] - 1

**2. 地图动画 spritesheet 的缓存与解析（前端）**
- 位置：[`PixiStaticMap.tsx`](AstrTown/src/components/PixiStaticMap.tsx)
- 功能：避免重复 parse 导致 Pixi TextureCache 冲突
- 实现：
  - 模块级缓存 Map<string, Promise<PIXI.Spritesheet>>
  - key 为 textureUrl 或 url
  - 避免多个实例重复解析

**3. 移动耗时计算使用共享常量 movementSpeed**
- 位置：[`movement.ts`](AstrTown/convex/aiTown/movement.ts)
- 功能：按速度将路径段长度换算成耗时
- 实现：
  - import movementSpeed（0.75 tiles/second）
  - 路径段长度 / movementSpeed

#### 3.10.4 模块间关系

- **被依赖**：
  - convex/根目录（init、world、player）
  - convex/aiTown（agentInputs、movement）
  - src/components（Player、PixiStaticMap）

---

### 3.11 plugin 模块

#### 3.11.1 模块概述

该模块是 AstrBot 的平台适配插件，通过 Gateway 将 AstrTown 游戏世界抽象为消息平台。

本轮架构变更后，插件新增：
- 反思 LLM 回调注入/清理机制
- `social.*` 事件处理链路
- 会话对方追踪与“对话结束后异步反思”流水线
- 关系提议/回应工具能力
- 动态社交张力 system context 注入

#### 3.11.2 核心功能

| 功能 | 实现文件 | 说明 |
|------|---------|------|
| 插件主入口 | [`main.py`](astrbot_plugin_astrtown/main.py) | 定义 LLM 工具、上下文裁剪、动态记忆/社交 context 注入 |
| 平台适配器 | [`adapter/astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py) | WebSocket 连接、消息处理、social 事件处理、异步反思任务 |
| 协议定义 | [`adapter/protocol.py`](astrbot_plugin_astrtown/adapter/protocol.py) | WebSocket 协议数据模型 |
| 事件类 | [`adapter/astrtown_event.py`](astrbot_plugin_astrtown/adapter/astrtown_event.py) | 消息事件类定义 |
| ID 工具 | [`adapter/id_util.py`](astrbot_plugin_astrtown/adapter/id_util.py) | ID 生成工具 |
| 配置 schema | [`_conf_schema.json`](astrbot_plugin_astrtown/_conf_schema.json) | 配置项元数据定义 |
| 插件元数据 | [`metadata.yaml`](astrbot_plugin_astrtown/metadata.yaml) | 插件基本信息 |
| NPC 行为指导 | [`SKILL.md`](astrbot_plugin_astrtown/SKILL.md) | NPC 行为指导文档 |

#### 3.11.3 关键算法

**1. WebSocket 连接循环（带重连）**
- 位置：[`astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py)
- 功能：建立并维护 WebSocket 连接
- 实现：
  - 指数退避重连策略
  - 添加随机抖动
  - 捕获异常并记录日志

**2. 对话结束异步反思流水线**
- 位置：[`_async_reflect_on_conversation()`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py:1304)
- 功能：对话结束后异步生成反思并写回记忆/好感
- 实现：
  - 通过注入的 LLM 回调生成 `summary/importance/affinity_delta`
  - 调用 `/api/bot/memory/inject` 注入记忆
  - 调用 `/api/bot/social/affinity` 更新好感
  - 累计阈值后触发高阶反思 `_async_higher_reflection`

**3. 动态上下文注入（记忆 + 社交张力）**
- 位置：[`_astrtown_trim_context_and_inject_memory()`](astrbot_plugin_astrtown/main.py:24)
- 功能：在 LLM 请求前注入最近记忆和公开社交状态
- 实现：
  - 调用 `search_world_memory` 注入记忆片段 system context
  - 调用 `/api/bot/social/state` 注入关系/好感“表里关系”张力提示

#### 3.11.4 模块间关系

- **依赖**：
  - Gateway（WebSocket/HTTP）
  - AstrBot 框架（Star、filter、Context）
  - social/memory 代理端点（`/api/bot/social/*`、`/api/bot/memory/*`）
- **被依赖**：
  - AstrBot 主程序

---

## 4. 模块间关系图

### 4.1 顶层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  React UI    │  │  Pixi 渲染   │  │  Hooks/工具   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      WebSocket 网关                         │
│                   (gateway 模块)                           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Convex 后端                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ aiTown 引擎   │  │ Agent 系统   │  │  API 服务    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     数据层 (data)                          │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                  AstrBot 插件 (plugin)                      │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 模块依赖关系

#### 4.2.1 gateway 模块依赖

```
gateway
├── 依赖
│   ├── AstrBot 插件（WebSocket 连接）
│   ├── Bot/NPC 客户端（WebSocket 连接）
│   ├── Convex 后端（HTTP API）
│   └── ConnectionManager 多索引（token/agentId/playerId）
└── 被依赖
    ├── Bot 客户端
    ├── NPC 客户端
    └── AstrBot 插件
```

#### 4.2.2 convex/engine/util 模块依赖

```
convex/engine/util
├── 依赖
│   ├── Convex 数据库
│   ├── OpenAI API（LLM）
│   └── Node.js 内置模块
└── 被依赖
    ├── aiTown 引擎
    ├── Agent 系统
    ├── 移动系统
    └── 对话系统
```

#### 4.2.3 convex/agent 模块依赖

```
convex/agent
├── 依赖
│   ├── Convex 数据库
│   ├── util/llm（embedding）
│   └── aiTown/ids（ID 类型）
└── 被依赖
    ├── botApi（memory/search、memory/recent、memory/inject）
    └── 外部控制 NPC（经 botApi + gateway 间接调用）
```

#### 4.2.4 aiTown/基础 模块依赖

```
aiTown/基础
├── 依赖
│   ├── engine/abstractGame（引擎抽象）
│   ├── util/geometry（几何计算）
│   ├── data/characters（角色数据）
│   └── data/gentle（地图数据）
└── 被依赖
    ├── aiTown Agent
    ├── 前端渲染
    └── convex 根目录
```

#### 4.2.5 aiTown/agent 模块依赖

```
aiTown/agent
├── 依赖
│   ├── aiTown 基础模块
│   ├── 记忆链路由 botApi/memory 异步注入（不直接依赖 convex/agent）
│   ├── engine/abstractGame
│   └── util/geometry
└── 被依赖
    ├── convex 根目录
    ├── botApi/npcService
    └── 前端（通过 API）
```

#### 4.2.6 convex/根目录 模块依赖

```
convex/根目录
├── 依赖
│   ├── aiTown/基础、agent、engine/util
│   ├── data/characters、data/gentle
│   ├── Replicate API（音乐生成）
│   └── Node.js 内置模块
└── 被依赖
    ├── 前端（通过 API）
    ├── gateway（通过 HTTP 代理）
    └── botApi/npcService（含 internal.social.* 调用链）
```

#### 4.2.7 convex/botApi-npcService 模块依赖

```
convex/botApi-npcService
├── 依赖
│   ├── aiTown/agent、aiTown/基础
│   ├── convex/根目录（auth、world、social）
│   ├── convex/agent（memory）
│   ├── data/characters
│   └── Convex 数据库
└── 被依赖
    ├── gateway（通过 HTTP）
    └── AstrBot 插件（经 gateway 间接调用）
```

#### 4.2.8 src/components 模块依赖

```
src/components
├── 依赖
│   ├── convex/根目录（API）
│   ├── src/hooks（useAuth、useServerGame、useHistoricalTime、useSendInput）
│   ├── data/characters（角色数据）
│   ├── Pixi.js、@pixi/react、pixi-viewport、@pixi/sound
│   ├── react-i18next
│   └── react-modal、react-toastify
└── 被依赖
    └── src/App.tsx
```

#### 4.2.9 src/其他 模块依赖

```
src/其他
├── 依赖
│   ├── convex/根目录（API）
│   ├── convex/aiTown（类型）
│   ├── React、React Hooks
│   ├── Convex React SDK
│   └── i18next
└── 被依赖
    └── src/components
```

#### 4.2.10 data 模块依赖

```
data
├── 依赖
│   ├── Node.js 内置模块（fs、process）
│   └── 外部资源文件（PNG、JSON）
└── 被依赖
    ├── convex/根目录（init、world、player）
    ├── convex/aiTown（agentInputs、movement）
    └── src/components（Player、PixiStaticMap）
```

#### 4.2.11 plugin 模块依赖

```
plugin
├── 依赖
│   ├── Gateway（WebSocket/HTTP）
│   ├── AstrBot 框架（Star、filter、Context）
│   ├── websockets 库
│   ├── aiohttp 库
│   └── Convex botApi social/memory 端点（经 gateway 代理）
└── 被依赖
    └── AstrBot 主程序
```

### 4.3 数据流向

#### 4.3.1 用户操作流向

```
用户操作
    ↓
前端 UI (src/components)
    ↓
Hooks (src/hooks)
    ↓
Convex API (convex/根目录)
    ↓
游戏引擎 (aiTown/基础、aiTown/agent)
    ↓
数据库 (Convex)
    ↓
前端订阅更新
    ↓
UI 更新
```

#### 4.3.2 Bot/NPC 控制流向

```
Bot/NPC 客户端
    ↓
WebSocket 网关 (gateway)
    ↓
[关系命令分流]
    ├─ propose/respond_relationship → 网关本地处理 + social 事件入队
    └─ 其他命令 → HTTP API (convex/botApi-npcService)
                    ↓
                 游戏引擎 (aiTown/agent)
                    ↓
                 数据库 (Convex)
                    ↓
WebSocket 事件推送（含 social.relationship_*）
    ↓
Bot/NPC 客户端接收更新
```

#### 4.3.3 AstrBot 插件控制流向

```
AstrBot 主程序
    ↓
AstrBot 插件 (plugin)
    ↓
WebSocket 网关 (gateway)
    ↓
HTTP API (convex/botApi-npcService)
    ↓
游戏引擎 (aiTown/agent)
    ↓
数据库 (Convex)
    ↓
WebSocket 事件推送（含 social.*）
    ↓
AstrBot 插件接收事件
    ↓
LLM 处理 + 动态社交张力 context 注入
    ↓
AstrBot 插件发送命令
    ↓
WebSocket 网关
    ↓
游戏引擎执行
```

#### 4.3.4 记忆与社交扩展流向（新增）

```
对话结束/事件触发
    ↓
AstrBot adapter 异步反思任务
    ↓
Gateway 代理 API
    ├─ POST /api/bot/memory/inject
    ├─ POST /api/bot/social/affinity
    ├─ GET  /api/bot/memory/recent
    └─ GET  /api/bot/social/state
    ↓
Convex botApi
    ↓
internal.agent.memory / internal.social
    ↓
memories + affinities + relationships
```

---

## 5. 架构特点

### 5.1 架构优势

#### 5.1.1 分层清晰

项目采用清晰的分层架构：
- **前端层**：React + Pixi.js，负责 UI 展示和用户交互
- **网关层**：WebSocket 网关，负责连接管理和消息路由
- **后端层**：Convex 后端，负责业务逻辑和数据存储
- **数据层**：静态数据，提供游戏资源

#### 5.1.2 模块解耦

各模块职责单一，耦合度低：
- gateway 模块独立运行，不依赖具体业务逻辑
- convex 各子模块（aiTown、agent、engine/util）职责清晰
- 前端组件模块化，可复用性强

#### 5.1.3 实时同步

使用 Convex 的实时同步能力：
- 前端通过 useQuery 订阅数据变化
- 数据变化自动推送到前端
- 无需手动轮询，降低服务器负载

#### 5.1.4 扩展性强

支持多种接入方式：
- WebSocket 网关：支持 Bot/NPC 客户端
- HTTP API：支持外部系统集成
- AstrBot 插件：支持 LLM 驱动的 NPC

#### 5.1.5 性能优化

多处性能优化：
- 历史对象压缩：减少数据传输量
- spritesheet 缓存：避免重复解析
- 优先级队列：保证高优先级事件优先处理
- 幂等性控制：避免重复请求

### 5.2 潜在问题

#### 5.2.1 文件过大

部分文件过大，维护困难：
- [`botApi.ts`](AstrTown/convex/botApi.ts)：40,517 字符，1,218 行
- [`npcService.ts`](AstrTown/convex/npcService.ts)：15,763 字符，505 行
- [`astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py)：67,552 字符，1,738 行

#### 5.2.2 模块职责不清

部分模块职责不够清晰：
- convex/根目录：12 个文件，功能混杂
- src/components：26 个文件，组件过多

#### 5.2.3 缺少测试

测试覆盖率不足：
- 大部分模块缺少单元测试
- 只有部分 util 模块有测试文件

#### 5.2.4 文档不完整

文档不足：
- 部分模块缺少详细注释
- 缺少架构设计文档
- 缺少 API 文档

#### 5.2.5 错误处理不统一

错误处理方式不一致：
- 部分模块使用 throw
- 部分模块使用 ConvexError
- 部分模块使用自定义错误类型

### 5.3 优化建议

#### 5.3.1 文件拆分

建议拆分大文件：
- [`botApi.ts`](AstrTown/convex/botApi.ts)：按功能拆分为多个文件
- [`npcService.ts`](AstrTown/convex/npcService.ts)：拆分为多个服务文件
- [`astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py)：拆分事件处理与反思流水线子模块

#### 5.3.2 模块重组

建议重组模块：
- convex/根目录：按功能拆分为多个子模块
- src/components：按功能拆分为多个子目录

#### 5.3.3 增加测试

建议增加测试：
- 为核心业务逻辑添加单元测试
- 为关键算法添加集成测试
- 为 API 端点添加端到端测试

#### 5.3.4 完善文档

建议完善文档：
- 添加架构设计文档
- 添加 API 文档
- 添加开发指南
- 添加部署文档

#### 5.3.5 统一错误处理

建议统一错误处理：
- 定义统一的错误类型
- 统一错误处理流程
- 添加错误日志和监控

---

## 6. 技术债务

### 6.1 技术债务清单

| 序号 | 技术债务 | 模块 | 优先级 | 说明 |
|------|---------|------|--------|------|
| 1 | 文件过大 | convex/botApi-npcService | 高 | botApi.ts 1,218 行，npcService.ts 505 行 |
| 2 | 模块职责不清 | convex/根目录 | 高 | 12 个文件功能混杂 |
| 3 | 缺少测试 | 全局 | 高 | 大部分模块缺少单元测试 |
| 4 | 文档不完整 | 全局 | 中 | 缺少架构设计文档、API 文档 |
| 5 | 错误处理不统一 | 全局 | 中 | 错误处理方式不一致 |
| 6 | 前端组件过多 | src/components | 中 | 26 个组件文件 |
| 7 | 缺少类型定义 | 全局 | 低 | 部分模块缺少 TypeScript 类型定义 |
| 8 | 缺少性能监控 | 全局 | 低 | 缺少性能指标收集和监控 |
| 9 | 缺少日志系统 | 全局 | 低 | 缺少统一的日志系统 |
| 10 | 缺少配置管理 | 全局 | 低 | 配置分散，缺少统一管理 |

### 6.2 技术债务详细说明

#### 6.2.1 文件过大

**问题描述**：
- [`botApi.ts`](AstrTown/convex/botApi.ts)：40,517 字符，1,218 行
- [`npcService.ts`](AstrTown/convex/npcService.ts)：15,763 字符，505 行
- [`astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py)：67,552 字符，1,738 行

**影响**：
- 维护困难
- 代码审查困难
- 新人上手慢

**建议**：
- 按功能拆分为多个文件
- 每个文件职责单一
- 文件行数控制在 300 行以内

#### 6.2.2 模块职责不清

**问题描述**：
- [`convex/根目录`](AstrTown/convex/)：12 个文件，功能混杂
- [`src/components`](AstrTown/src/components/)：26 个组件文件

**影响**：
- 模块耦合度高
- 代码复用困难
- 测试困难

**建议**：
- 按功能拆分子模块
- 明确模块职责
- 减少模块间依赖

#### 6.2.3 缺少测试

**问题描述**：
- 大部分模块缺少单元测试
- 只有部分 util 模块有测试文件
- 缺少集成测试和端到端测试

**影响**：
- 代码质量难以保证
- 重构风险高
- Bug 难以发现

**建议**：
- 为核心业务逻辑添加单元测试
- 为关键算法添加集成测试
- 为 API 端点添加端到端测试
- 目标测试覆盖率：80% 以上

#### 6.2.4 文档不完整

**问题描述**：
- 缺少架构设计文档
- 缺少 API 文档
- 缺少开发指南
- 缺少部署文档

**影响**：
- 新人上手慢
- 团队协作困难
- 知识传承困难

**建议**：
- 添加架构设计文档
- 添加 API 文档（使用 Swagger/OpenAPI）
- 添加开发指南
- 添加部署文档

#### 6.2.5 错误处理不统一

**问题描述**：
- 部分模块使用 throw
- 部分模块使用 ConvexError
- 部分模块使用自定义错误类型

**影响**：
- 错误处理不一致
- 错误信息不统一
- 调试困难

**建议**：
- 定义统一的错误类型
- 统一错误处理流程
- 添加错误日志和监控
- 使用错误码和错误消息

#### 6.2.6 前端组件过多

**问题描述**：
- [`src/components`](AstrTown/src/components/)：26 个组件文件
- 组件职责不够清晰
- 组件间依赖复杂

**影响**：
- 组件复用困难
- 性能优化困难
- 维护成本高

**建议**：
- 按功能拆分子目录
- 提取公共组件
- 减少组件间依赖
- 使用组件库（如 shadcn/ui）

#### 6.2.7 缺少类型定义

**问题描述**：
- 部分模块缺少 TypeScript 类型定义
- 使用 any 类型过多
- 类型推导不准确

**影响**：
- 类型安全性低
- IDE 提示不准确
- 运行时错误风险高

**建议**：
- 添加完整的类型定义
- 减少 any 类型使用
- 使用类型推导
- 启用严格类型检查

#### 6.2.8 缺少性能监控

**问题描述**：
- 缺少性能指标收集
- 缺少性能监控
- 缺少性能分析工具

**影响**：
- 性能问题难以发现
- 优化效果难以评估
- 用户体验难以保证

**建议**：
- 添加性能指标收集
- 添加性能监控（如 Prometheus、Grafana）
- 添加性能分析工具（如 Lighthouse）
- 定期进行性能评估

#### 6.2.9 缺少日志系统

**问题描述**：
- 缺少统一的日志系统
- 日志级别不统一
- 日志格式不统一

**影响**：
- 问题排查困难
- 系统监控困难
- 审计追踪困难

**建议**：
- 添加统一的日志系统（如 Winston、Pino）
- 统一日志级别
- 统一日志格式（JSON）
- 添加日志聚合和分析工具

#### 6.2.10 缺少配置管理

**问题描述**：
- 配置分散在多个文件
- 缺少统一配置管理
- 环境变量管理不规范

**影响**：
- 配置管理困难
- 环境切换困难
- 配置错误风险高

**建议**：
- 添加统一配置管理
- 使用配置中心（如 Consul、Etcd）
- 规范环境变量管理
- 添加配置验证

---

## 7. 附录

### 7.1 文件统计汇总

#### 7.1.1 按模块统计

| 模块 | 文件数 | 总行数 | 总字符数 |
|------|--------|--------|----------|
| gateway | 20 | 3,142 | 98,819 |
| convex/engine/util | 21 | ~1,800 | 41,155 |
| convex/agent | 3 | 399 | 12,232 |
| aiTown/基础 | 10 | ~1,200 | 27,123 |
| aiTown/agent | 7 | ~585 | 31,157 |
| convex/根目录 | 12 | 2,006 | 59,249 |
| convex/botApi-npcService | 2 | 1,723 | 54,556 |
| src/components | 26 | 2,760 | 94,600 |
| src/其他 | 10 | ~800 | 26,382 |
| data | 21 | ~1,500 | 26,382 |
| plugin | 10 | 2,593 | 95,467 |
| **合计** | **142** | **~18,508** | **~567,122** |

#### 7.1.2 按类型统计

| 类型 | 文件数 | 总字符数 | 占比 |
|------|--------|----------|------|
| TypeScript (.ts/.tsx) | ~120 | ~380,000 | 80.7% |
| JavaScript (.js) | ~15 | ~75,000 | 15.9% |
| JSON (.json) | ~5 | ~10,000 | 2.1% |
| YAML (.yaml) | ~1 | ~280 | 0.1% |
| 其他 | ~1 | ~5,535 | 1.2% |

#### 7.1.3 按目录统计

| 目录 | 文件数 | 总字符数 |
|------|--------|----------|
| gateway/ | 20 | 98,819 |
| AstrTown/convex/ | ~70 | ~220,000 |
| AstrTown/src/ | ~40 | ~140,000 |
| AstrTown/data/ | 21 | 26,382 |
| astrbot_plugin_astrtown/ | 10 | 95,467 |
| 其他 | ~10 | ~5,000 |

### 7.2 依赖关系图

#### 7.2.1 核心依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| React | 18 | UI 框架 |
| TypeScript | ~5.0 | 类型系统 |
| Vite | ~5.0 | 构建工具 |
| Convex | 最新 | 后端框架 |
| Pixi.js | ~7.0 | 2D 渲染 |
| @pixi/react | ~3.0 | Pixi React 集成 |
| pixi-viewport | ~5.0 | 视口控制 |
| @pixi/sound | ~5.0 | 音频播放 |
| Tailwind CSS | ~3.0 | 样式框架 |
| react-i18next | ~13.0 | 国际化 |
| react-modal | ~3.0 | 模态框 |
| react-toastify | ~9.0 | 通知 |
| uPlot | ~1.0 | 图表 |
| websockets | ~13.0 | WebSocket 客户端 |

#### 7.2.2 开发依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| Node.js | ~18.0 | JavaScript 运行时 |
| npm | ~9.0 | 包管理器 |
| Docker | ~24.0 | 容器化 |
| docker-compose | ~2.0 | 多容器编排 |
| Python | ~3.10 | AstrBot 插件 |

### 7.3 相关文档链接

| 文档 | 路径 | 说明 |
|------|------|------|
| 项目架构分析 - gateway | [`plans/架构分析-gateway.md`](plans/架构分析-gateway.md) | gateway 模块详细分析 |
| 项目架构分析 - convex/engine/util | [`plans/架构分析-convex-engine-util.md`](plans/架构分析-convex-engine-util.md) | engine/util 模块详细分析 |
| 项目架构分析 - convex/agent | [`plans/架构分析-convex-agent.md`](plans/架构分析-convex-agent.md) | agent 模块详细分析 |
| 项目架构分析 - aiTown/基础 | [`plans/架构分析-aiTown-基础.md`](plans/架构分析-aiTown-基础.md) | aiTown 基础模块详细分析 |
| 项目架构分析 - aiTown/agent | [`plans/架构分析-aiTown-agent.md`](plans/架构分析-aiTown-agent.md) | aiTown Agent 模块详细分析 |
| 项目架构分析 - convex/根目录 | [`plans/架构分析-convex-根目录.md`](plans/架构分析-convex-根目录.md) | convex 根目录模块详细分析 |
| 项目架构分析 - convex/botApi-npcService | [`plans/架构分析-convex-botApi-npcService.md`](plans/架构分析-convex-botApi-npcService.md) | botApi/npcService 模块详细分析 |
| 项目架构分析 - src/components | [`plans/架构分析-src-components.md`](plans/架构分析-src-components.md) | src/components 模块详细分析 |
| 项目架构分析 - src/其他 | [`plans/架构分析-src-其他.md`](plans/架构分析-src-其他.md) | src/其他 模块详细分析 |
| 项目架构分析 - data | [`plans/架构分析-data.md`](plans/架构分析-data.md) | data 模块详细分析 |
| 项目架构分析 - plugin | [`plans/架构分析-plugin.md`](plans/架构分析-plugin.md) | plugin 模块详细分析 |
| NPC 对话历史记录改造方案 | [`AstrTown/NPC 对话历史记录改造方案.md`](AstrTown/NPC 对话历史记录改造方案.md) | NPC 历史改造方案 |
| 事件链路审查与保护清单 | [`事件链路审查与保护清单.md`](事件链路审查与保护清单.md) | 事件链路审查清单 |
| AGENTS.md | [`AGENTS.md`](AGENTS.md) | Agent 规则 |

### 7.4 关键算法索引

| 算法 | 位置 | 模块 |
|------|------|------|
| WebSocket 连接循环 | [`wsHandler.ts`](gateway/src/wsHandler.ts) | gateway |
| 命令路由 | [`commandRouter.ts`](gateway/src/commandRouter.ts) | gateway |
| 事件分发 | [`eventDispatcher.ts`](gateway/src/eventDispatcher.ts) | gateway |
| 幂等性控制 | [`wsHandler.ts`](gateway/src/wsHandler.ts) | gateway |
| 历史对象压缩 | [`historicalObject.ts`](AstrTown/convex/engine/historicalObject.ts) | engine |
| A* 寻路 | [`geometry.ts`](AstrTown/convex/util/geometry.ts) | util |
| 向量检索 | [`llm.ts`](AstrTown/convex/util/llm.ts) | util |
| 外部记忆注入数据构建 | [`memory.ts`](AstrTown/convex/agent/memory.ts:23) | agent |
| 记忆检索 | [`memory.ts`](AstrTown/convex/agent/memory.ts) | agent |
| Agent 状态机 | [`agent.ts`](AstrTown/convex/aiTown/agent.ts) | aiTown/agent |
| 外部控制模式 | [`agent.ts`](AstrTown/convex/aiTown/agent.ts) | aiTown/agent |
| Vacuum 分页清理 | [`crons.ts`](AstrTown/convex/crons.ts) | convex/根目录 |
| 社交关系归一化写入 | [`upsertRelationship`](AstrTown/convex/social.ts:52) | convex/根目录 |
| 好感度区间更新 | [`updateAffinity`](AstrTown/convex/social.ts:11) | convex/根目录 |
| 命令映射 | [`botApi.ts`](AstrTown/convex/botApi.ts) | botApi |
| NPC 创建等待 | [`npcService.ts`](AstrTown/convex/npcService.ts) | npcService |
| 地图点击移动 | [`PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx) | src/components |
| screen 坐标转换 | [`PixiGame.tsx`](AstrTown/src/components/PixiGame.tsx) | src/components |
| 消息时间序合并 | [`Messages.tsx`](AstrTown/src/components/Messages.tsx) | src/components |
| spritesheet 解析缓存 | [`Character.tsx`](AstrTown/src/components/Character.tsx) | src/components |
| 历史时间插值 | [`useHistoricalTime.ts`](AstrTown/src/hooks/useHistoricalTime.ts) | src/hooks |
| 输入等待 | [`sendInput.ts`](AstrTown/src/hooks/sendInput.ts) | src/hooks |
| 认证 URL 推导 | [`useAuth.tsx`](AstrTown/src/hooks/useAuth.tsx) | src/hooks |
| 地图 layer 转换 | [`convertMap.js`](AstrTown/data/convertMap.js) | data |
| WebSocket 连接循环 | [`astrtown_adapter.py`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py) | plugin |
| 对话结束异步反思流水线 | [`_async_reflect_on_conversation()`](astrbot_plugin_astrtown/adapter/astrtown_adapter.py:1304) | plugin |
| 动态上下文注入 | [`_astrtown_trim_context_and_inject_memory()`](astrbot_plugin_astrtown/main.py:24) | plugin |

### 7.5 数据库表清单

| 表名 | 模块 | 说明 |
|------|------|------|
| worlds | aiTown/基础 | 世界信息 |
| engines | aiTown/基础 | 引擎信息 |
| maps | aiTown/基础 | 地图信息 |
| players | aiTown/基础 | 玩家信息 |
| conversations | aiTown/基础 | 对话信息 |
| agents | aiTown/agent | Agent 信息 |
| inputs | aiTown/agent | 输入信息 |
| memories | agent | 记忆信息 |
| memoryEmbeddings | agent | 记忆向量 |
| affinities | aiTown/基础 + social | 玩家单向好感度（owner-target） |
| relationships | aiTown/基础 + social | 玩家双向关系状态（排序键） |
| messages | convex/根目录 | 消息存储 |
| users | convex/根目录 | 用户信息 |
| sessions | convex/根目录 | 会话信息 |
| oauthAccounts | convex/根目录 | OAuth 账户 |
| botTokens | convex/根目录 | Bot Token |
| music | convex/根目录 | 音乐信息 |
| playerDescriptions | convex/根目录 | 玩家描述 |
| archivedAgents | convex/根目录 | 归档 Agent |
| archivedConversations | convex/根目录 | 归档对话 |
| participatedTogether | convex/根目录 | 对话关系 |

### 7.6 API 端点清单

#### 7.6.1 HTTP API 端点

| 方法 | 路径 | 处理函数 | 模块 |
|------|------|---------|------|
| POST | `/api/bot/command` | [`postCommand`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/command/batch` | [`postCommandBatchHttp`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/event` | [`postEventAck`](AstrTown/convex/botApi.ts) | botApi |
| GET | `/api/bot/world-state` | [`getWorldState`](AstrTown/convex/botApi.ts) | botApi |
| GET | `/api/bot/agent-status` | [`getAgentStatus`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/token/validate` | [`postTokenValidate`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/description/update` | [`postDescriptionUpdate`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/token/create` | [`postTokenCreate`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/memory/search` | [`postMemorySearch`](AstrTown/convex/botApi.ts) | botApi |
| GET | `/api/bot/memory/recent` | [`getRecentMemories`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/memory/inject` | [`postMemoryInject`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/social/affinity` | [`postSocialAffinity`](AstrTown/convex/botApi.ts) | botApi |
| GET | `/api/bot/social/state` | [`getSocialState`](AstrTown/convex/botApi.ts) | botApi |
| POST | `/api/bot/social/relationship` | [`postSocialRelationship`](AstrTown/convex/botApi.ts) | botApi |
| OPTIONS | `/api/npc/*` | [`optionsNpc`](AstrTown/convex/npcService.ts) | npcService |
| POST | `/api/npc/create` | [`postNpcCreate`](AstrTown/convex/npcService.ts) | npcService |
| GET | `/api/npc/list` | [`getNpcList`](AstrTown/convex/npcService.ts) | npcService |
| POST | `/api/npc/reset-token` | [`postNpcResetToken`](AstrTown/convex/npcService.ts) | npcService |
| GET | `/api/npc/token/:id` | [`getNpcTokenById`](AstrTown/convex/npcService.ts) | npcService |
| POST | `/api/auth/register` | [`postAuthRegister`](AstrTown/convex/auth.ts) | auth |
| POST | `/api/auth/login` | [`postAuthLogin`](AstrTown/convex/auth.ts) | auth |
| POST | `/api/auth/logout` | [`postAuthLogout`](AstrTown/convex/auth.ts) | auth |
| GET | `/api/auth/me` | [`getAuthMe`](AstrTown/convex/auth.ts) | auth |
| OPTIONS | `/api/auth/*` | [`optionsAuth`](AstrTown/convex/auth.ts) | auth |
| POST | `/replicate_webhook` | [`handleReplicateWebhook`](AstrTown/convex/music.ts) | music |

#### 7.6.2 WebSocket 协议

| 消息类型 | 说明 |
|---------|------|
| ping | 心跳检测 |
| pong | 心跳响应 |
| connected | 连接成功 |
| auth_error | 认证错误 |
| command.ack | 命令确认 |
| event.ack | 事件确认 |
| conversation.invited | 对话邀请 |
| conversation.message | 对话消息 |
| conversation.started | 对话开始 |
| conversation.timeout | 对话超时兜底事件 |
| agent.state_changed | Agent 状态变化 |
| action.finished | 动作完成 |
| agent.queue_refill_requested | 队列补充请求 |
| social.relationship_proposed | 关系提议事件 |
| social.relationship_responded | 关系回应事件 |

---

**文档版本**: 1.1
**创建日期**: 2026-02-22
**最后更新**: 2026-02-24
**作者**: 架构分析工具
**文档状态**: 完成

